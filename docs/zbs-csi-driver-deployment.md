---
id: zbs-csi-driver-deployment
title: Deployment
sidebar_label: Deployment
---

This topic explains how to install ZBS CSI Driver with kubernetes. Follow the steps in this topic in order.

## Env

- Centos7

- Kubernetes v1.17 or higher

## Setup Kubernetes

If there is no kubernetes clusterï¼Œplease refer to [Installing Kubernetes](https://kubernetes.io/docs/setup/production-environment/tools/).

### Enable Kubernetes features

1. Enable feature gates on each `kube-apiserver`: `--feature-gates=CSINodeInfo=true,CSIDriverRegistry=true,CSIBlockVolume=true,VolumeSnapshotDataSource=true,VolumePVCDataSource=true,VolumePVCDataSource=true,ExpandCSIVolumes=true,ExpandInUsePersistentVolumes=true` and `--allow-privileged=true`.

```yaml
# /etc/kubernetes/manifests/kube-apiserver.yaml
apiVersion: v1
kind: Pod
metadata:
  name: kube-apiserver
  namespace: kube-system
spec:
  containers:
  - command:
    - kube-apiserver
    - --feature-gates=CSINodeInfo=true,CSIDriverRegistry=true,CSIBlockVolume=true,VolumeSnapshotDataSource=true, VolumePVCDataSource=true,VolumePVCDataSource=true,ExpandCSIVolumes=true,ExpandInUsePersistentVolumes=true
    - --allow-privileged=true
```

2. Enable feature gates on each `kubelet`: `--feature-gates=CSINodeInfo=true,CSIDriverRegistry=true,CSIBlockVolume=true,VolumeSnapshotDataSource=true, VolumePVCDataSource=true,VolumePVCDataSource=true,ExpandCSIVolumes=true,ExpandInUsePersistentVolumes=true` and `--allow-privileged=true`.

```yaml
# /usr/lib/systemd/system/kubelet.service.d/10-kubeadm.conf
# Note: This dropin only works with kubeadm and kubelet v1.11+
[Service]
Environment="KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf --feature-gates=CSINodeInfo=true,CSIDriverRegistry=true,CSIBlockVolume=true,VolumeSnapshotDataSource=true,VolumePVCDataSource=true,VolumePVCDataSource=true,ExpandCSIVolumes=true,ExpandInUsePersistentVolumes=true --allow-privileged=true"
Environment="KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml"
# This is a file that "kubeadm init" and "kubeadm join" generates at runtime, populating the KUBELET_KUBEADM_ARGS variable dynamically
EnvironmentFile=-/var/lib/kubelet/kubeadm-flags.env
# This is a file that the user can use for overrides of the kubelet args as a last resort. Preferably, the user should use
# the .NodeRegistration.KubeletExtraArgs object in the configuration files instead. KUBELET_EXTRA_ARGS should be sourced from this file.
EnvironmentFile=-/etc/sysconfig/kubelet
ExecStart=
ExecStart=/usr/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_KUBEADM_ARGS $KUBELET_EXTRA_ARGS
```

> **_Note:_ This configuration file is generated by kubeadm, other installation methods are similarly modified**

3. Reload Config

```sh
systemctl daemon-reload
systemctl restart kubelet
```

### Deploy Common Snapshot Controller

1. Download **[external-controller repo](https://github.com/kubernetes-csi/external-snapshotter/tree/release-2.1)**

```sh
wget https://github.com/kubernetes-csi/external-snapshotter/archive/release-2.1.zip
unzip external-snapshotter-release-2.1.zip
```

2. Create Snapshot Beta CRD

```sh
kubectl create -f external-snapshotter-release-2.1/config/crd
```

3. Install Common Snapshot Controller

```sh
kubectl apply -f external-snapshotter-release-2.1/deploy/kubernetes/snapshot-controller
```

4. Verify

```sh
kubectl get statefulsets.apps snapshot-controller
```

## Setup ZBS Cluster

Configure a `zbs-cluster-vip`

## Setup open-iscsi

```sh
yum install iscsi-initiator-utils
```

## Deploy zbs-csi-driver

Obtain the `kubernetes-cluster-id` from the  cluster administrator or the  cluster management system and download **[zbs-csi-driver-deploy](https://github.com/iomesh/zbs-csi-driver/blob/master/deploy)**.

> **_Note:_ `kubernetes-cluster-id` should be unique and cannot be modified**.

1. Configure controller plugin

```yaml
# deploy/zbs-csi-driver.yaml
        - name: zbs-csi-driver
          image: iomesh/zbs-csi-driver:v0.1.1
          args:
            - "--role=controller"
            - "--driver_name=zbs-csi-driver.iomesh.com"
            - "--meta_proxy=zbs-cluster-vip:10206"
            - "--cluster_id=kubernetes-cluster-id"
            - "--deployment_mode=EXTERNAL"
```

2. Configure node plugin

```yaml
# deploy/zbs-csi-driver.yaml
        - name: zbs-csi-driver
          image: iomesh/zbs-csi-driver:v0.1.1
          args:
            - "--role=node"
            - "--driver_name=zbs-csi-driver.iomesh.com"
            - "--meta_proxy=zbs-cluster-vip:10206"
            - "--cluster_id=kubernetes-cluster-id"
            - "--iscsi_portal=zbs-cluster-vip:3260"
            - "--deployment_mode=EXTERNAL"
```

> **_Note:_ For HCI Deployment, `deployment_mode` is `HCI` , `iscsi_portal` is `127.0.0.1:3260`**

3. Configure StorageClass

```yaml
# deploy/zbs-csi-driver.yaml
kind: StorageClass
apiVersion: storage.k8s.io/v1
metadata:
  name: zbs-csi-driver-default
# zbs-csi-driver name
provisioner: zbs-csi-driver.iomesh.com
reclaimPolicy: Retain
allowVolumeExpansion: true
```

4. Deploy

```sh
kubectl apply -f ./deploy
```

5. Verify

```sh
kubectl get pod -n iomesh-system
```

## Example

TODO
